name: Evolver Validation

on:
  push:
    branches: [main]
    paths:
      - "src/**"
  pull_request:
    paths:
      - "src/**"

concurrency:
  group: evolver-${{ github.event.pull_request.number || github.sha }}
  cancel-in-progress: true

jobs:
  validate-evolver:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node environment
        uses: ./.github/actions/setup-node-env
        with:
          install-bun: "false"

      - name: Lint
        run: pnpm lint

      - name: Build
        run: pnpm build

      - name: Test
        run: pnpm test

      - name: Validate Evolver daemon entry
        run: |
          node -e "
            const fs = require('fs');
            const entry = 'dist/evolver/daemon-entry.js';
            if (!fs.existsSync(entry)) {
              console.error('Missing evolver daemon entry: ' + entry);
              process.exit(1);
            }
            // Verify evolve bundle exists â€” either as a named entry (evolve.js)
            // or as a code-split hash chunk (evolve-<hash>.js)
            const files = fs.readdirSync('dist/evolver');
            const hasEvolveChunk = files.some(f => f === 'evolve.js' || (f.startsWith('evolve-') && f.endsWith('.js')));
            if (!hasEvolveChunk) {
              console.error('Missing bundled evolve chunk in dist/evolver/');
              process.exit(1);
            }
            console.log('Evolver daemon entry and evolve chunk compiled successfully');
          "
